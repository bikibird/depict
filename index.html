<!DOCTYPE html>
<html>
<head>
<title>Depict: Image Demake Tool for PICO-8</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
	<input type="file" class="d-none" accept="image/*" id="fileInput"/>
	<div class="container">
	<div class="row"><h1 class="text-center display-4">Depict: Image Demake Tool for PICO-8</h1></div>	
	<div class="row">
		<div class="col"><canvas id="original"></canvas></div>
		<div class="col">
			<p><input class="btn btn-info" type="button" value="Load Image File" id="loadButton"></p>
			<p><select class="form-select" aria-label="Shading" id="filterSelection" ></select></p>
			<p><input class="btn btn-info" type="button" value="Depict" id="depictButton"></p>
		</div>	
	</div>
	<div class="row">
		<div class="col">
			<canvas id="preview"></canvas>
		</div>
		<div class="col">
			<input class="btn btn-info" type="button" value="Download" id="downloadButton">
			<p class="d-none" id="picoHint">PICO-8 supports dragging and dropping image files from the operating system directly into the sprite sheet.</p>
		</div>
	</div>	
	
</div>	
	<!--a>https://www.pexels.com/photo/pink-rose-109813/</a-->
</body>
</html>	
<script src="depict.js"></script>
<script>
	var originalCanvas=document.getElementById("original")
	var depictionCanvas=document.createElement("canvas")
	var previewCanvas=document.getElementById("preview")
	var fileInput = document.getElementById("fileInput")
	var loadButton=document.getElementById("loadButton")
	var depictButton=document.getElementById("depictButton")
	depictButton.classList.add("d-none")
	var downloadButton=document.getElementById("downloadButton")
	downloadButton.classList.add("d-none")
	var picoHint=document.getElementById("picoHint")
	var filterSelection=document.getElementById("filterSelection")
	var innerHTML=""
	Object.keys(filters).forEach(key=>
	{
		innerHTML=innerHTML+`<option value="${key}" ${filters[key].default?"selected":""}>${key}</option>`
	})
	filterSelection.innerHTML=innerHTML

	var srcImage = new Image
	var imageReady=false
	var depicted=false
	var pico1=[
	0x000000, 0x1d2b53, 0x7e2553, 0x008751,
	0xab5236, 0x5f574f, 0xc2c3c7, 0xfff1e8,
	0xff004d, 0xffa300, 0xffec27, 0x00e436, 
	0x29adff, 0x83769c, 0xff77a8, 0xffccaa]

	fileInput.onchange = function (e)
	{
		if (e.target.files && e.target.files.item(0)) 
		{
			srcImage.src = URL.createObjectURL(e.target.files[0])
			imageReady=false
		}

	}
	srcImage.onload = function ()
	{
		var aspect=srcImage.width/srcImage.height
		if (srcImage.width>srcImage.height)
		{
			if(srcImage.width>512)
			{
				var width=512
				var height=Math.floor(512/aspect)	
			}
			else 
			{
				var width=srcImage.width
				var height=srcImage.height		
			}
		}
		else
		{
			if(srcImage.height>512)
			{
				var height=512
				var width=Math.floor(512*aspect)
			}
			else 
			{
				var width=srcImage.width
				var height=srcImage.height		
			}
		}
		originalCanvas.width=width
		originalCanvas.height=height
		var context =originalCanvas.getContext("2d")
		context.drawImage(srcImage, 0, 0, width, height)
		imageReady=true
		depictButton.classList.remove("d-none")
	}
	loadButton.onclick=function()
	{
		fileInput.click()
	}
	depictButton.onclick=function()
	{
		if (imageReady)
		{
			var {depiction,preview}=depict({original:srcImage,palette:pico1,filter:filters[filterSelection.value]})
			depictionCanvas.replaceWith(depiction)
			depictionCanvas=depiction
			previewCanvas.replaceWith(preview)
			previewCanvas=preview
			depicted=true
			downloadButton.classList.remove("d-none")
			picoHint.classList.remove("d-none")
		}
	}
	downloadButton.onclick=function()
	{
		if (depicted)
		{
			var link = document.createElement('a')
  			link.download = `depiction_${fileInput.files[0].name.split(".")[0]}.png`
  			link.href = depictionCanvas.toDataURL()
			link.click()
		}
	}

</script>	
